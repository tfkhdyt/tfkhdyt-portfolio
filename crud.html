<!-- Dibuat oleh Yopi Ardinal | 03-12-2018
diambil dari berbagai sumber. Silakan ubah sesuai hati
www.yopiardinal.wordpress.com -->

<!DOCTYPE html>
<html>
<head>
  <title></title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <script src="crud/firebase.js"></script>
  <script src="crud/jquery-3.2.1.slim.min.js"></script>
  <script src="crud/bootstrap.min.js"></script>
  <link rel="stylesheet" href="crud/bootstrap.min.css">
  <link rel="stylesheet" href="crud/fonts/font-awesome.min.css">
  <style type="text/css" media="all">
    table {
      table-layout: fixed;
      word-wrap: break-word;
    }
  </style>
</head>
<body onload="tampilData()">
  <script type="text/javascript" charset="utf-8">


  </script>
  <div style="padding:15px;padding-top:0;">
    <br>
    <div class="row no-gutters">
      <div class="col align-self-center">
        <h3 class="text-left"><i class="fa fa-home" onclick="tampilData()" style="cursor: pointer;"></i> CRUD</h3>
      </div>
      <div class="col align-self-center" style="padding:12px;">
        <input id="text_cari" type="text" placeholder="Cari berdasarkan Nama Project" class="form-control" style="padding:6px;" />
      </div>
      <div class="col-auto align-self-center" style="padding:6px;">
        <button class="btn btn-primary" type="button" onclick="CariData()"><i class="fa fa-search"></i></button>
      </div>
      <div class="col-auto align-self-center" style="padding:6px;">
        <button class="btn btn-success" type="button" id="tambah_data" style="margin-left:10px;" data-toggle="modal" data-target="#ModalAdd" onclick="ambilDataTerakhir()"><i class="fa fa-plus"></i></button>
      </div>
    </div>



    <table id="tabel-project" class="table table-striped table-bordered table-hover table-responsive table-sm">
      <thead class="thead-dark">
        <tr>
          <th scope="col">Id</th>
          <th scope="col" style="width:50%">Aksi</th>
          <th scope="col">Judul</th>
          <th scope="col">Deskripsi</th>
          <th scope="col">Tipe</th>
          <th scope="col" style="word-wrap: break-word;width: 40px;">Link</th>
          <th scope="col" style="word-wrap: break-word;width: 40px;">Foto</th>

        </tr>
      </thead>
      <tbody>

      </tbody>
    </table>


  </div>

  <script>

    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyD3tjHW1qh7x8iPWvqHnDlv2GZJSJfTWBg",
      authDomain: "tfkhdyt.firebaseapp.com",
      databaseURL: "https://tfkhdyt-default-rtdb.firebaseio.com",
      projectId: "tfkhdyt",
      storageBucket: "tfkhdyt.appspot.com",
      messagingSenderId: "142883227366",
      appId: "1:142883227366:web:9839a6fda843d7b8e71d27",
      measurementId: "G-P55V8988M2"
    };
    firebase.initializeApp(config);
    var dbRefPass = firebase.database();
    var refPass = dbRefPass.ref("user");
    refPass.on('value', handleSuccess);
    var pass = "";
    function handleSuccess(item) {
      pass = item.val().pass;
      var promptPass = prompt("Masukkan password");

      if (promptPass != pass) {
      alert("Password salah!");
      window.location.href = "https://tfkhdyt.web.app";
    }
    }
    
    // Menampilkan data dalam bentuk tabel
    function tampilData() {

      // Buat referensi database firebase
      var dbRef = firebase.database();
      var statusAlat = dbRef.ref("project");

      // Dapatkan referensi table
      var table = document.getElementById("tabel-project").getElementsByTagName('tbody')[0];

      // Membuang semua isi table
      $("#tabel-project").find("tr:gt(0)").remove();

      // Memuat Data
      statusAlat.on("child_added", function(data, prevChildKey) {
        var newstatusAlat = data.val();

        var row = table.insertRow(table.rows.length);

        var cell1 = row.insertCell(0);
        var cell7 = row.insertCell(1);
        var cell2 = row.insertCell(2);
        var cell3 = row.insertCell(3);
        var cell4 = row.insertCell(4);
        var cell5 = row.insertCell(5);
        var cell6 = row.insertCell(6);


        cell1.innerHTML = newstatusAlat.id;
        cell2.innerHTML = newstatusAlat.nama;
        cell3.innerHTML = newstatusAlat.deskripsi;
        cell4.innerHTML = newstatusAlat.tipe;
        cell5.innerHTML = newstatusAlat.link;
        cell6.innerHTML = newstatusAlat.foto;
        cell7.innerHTML = '<button class="btn btn-primary btn-block" type="button" id="update_data" onclick="updateData_Tampil(' + newstatusAlat.id + ')" data-toggle="modal" data-target="#ModalUpdate"><i class="fa fa-edit"></i></button><button class="btn btn-danger btn-block" type="button" id="delete_data" onclick="deleteData_Tampil(' + newstatusAlat.id + ')" data-toggle="modal" data-target="#ModalDel"><i class="fa fa-trash"></i></button>';
      });

    }

    // Melakukan proses pencarian data
    function CariData() {
      // Ambil isi text pencarian
      var nama_cari = $('#text_cari').val();

      // Buat referensi database firebase
      var dbRef = firebase.database();
      var statusAlat = dbRef.ref("project");


      // Ambil data nama sama persis isi text cari
      // var query = statusAlat
      // 				.orderByChild('nama')
      // 				.equalTo(nama_cari)
      // 				.limitToFirst(1);


      // Ambil data nama huruf depan (dan selebihnya) isi text cari dilimit 1 data saja
      // var query = statusAlat
      // 				.orderByChild('nama')
      // 				.startAt(nama_cari)
      // 				.endAt(nama_cari + "\uf8ff")
      // 				.limitToFirst(1);


      // Ambil data nama huruf depan (dan selebihnya) isi text cari
      var query = statusAlat
      .orderByChild('nama')
      .startAt(nama_cari)
      .endAt(nama_cari + "\uf8ff");


      // Dapatkan referensi table
      var table = document.getElementById("tabel-project").getElementsByTagName('tbody')[0];

      // Membuang semua isi table
      $("#tabel-project").find("tr:gt(0)").remove();

      // Memuat Data pencarian

      query.on("child_added", function(snapshot) {

        var childData = snapshot.val();
        console.log(childData);

        var row = table.insertRow(table.rows.length);

        var cell1 = row.insertCell(0);
        var cell7 = row.insertCell(1);
        var cell2 = row.insertCell(2);
        var cell3 = row.insertCell(3);
        var cell4 = row.insertCell(4);
        var cell5 = row.insertCell(5);
        var cell6 = row.insertCell(6);


        cell1.innerHTML = childData.id;
        cell2.innerHTML = childData.nama;
        cell3.innerHTML = childData.deskripsi;
        cell4.innerHTML = childData.tipe;
        cell5.innerHTML = childData.link;
        cell6.innerHTML = childData.foto;
        cell7.innerHTML = '<button class="btn btn-primary btn-block" type="button" id="update_data" onclick="updateData_Tampil(' + childData.id + ')" data-toggle="modal" data-target="#ModalUpdate"><i class="fa fa-edit"></i></button><button class="btn btn-danger btn-block" type="button" id="delete_data" onclick="deleteData_Tampil(' + childData.id + ')" data-toggle="modal" data-target="#ModalDel"><i class="fa fa-trash"></i></button>';
      });

    }

    // Menampilkan data yang akan di update kedalam modal update
    function updateData_Tampil(id) {
      $('#T4').val(id);

      var dbRef_update_tampil = firebase.database();
      var statusAlatdenganID = dbRef_update_tampil.ref("project/" + id);

      statusAlatdenganID.on("value", function(snapshot) {
        var childData = snapshot.val();
        $('#t4_nama').val(childData.nama);
        $('#t4_deskripsi').val(childData.deskripsi);
        $('#t4_tipe').val(childData.tipe);
        $('#t4_link').val(childData.link);
        $('#t4_foto').val(childData.foto);
      });

    }

    // Melakukan proses update data
    function updateData_Proses() {
      var id_update_proses = $('#T4').val();
      var nama_update_proses = $('#t4_nama').val();
      var deskripsi_update_proses = $('#t4_deskripsi').val();
      var tipe_update_proses = $('#t4_tipe').val();
      var link_update_proses = $('#t4_link').val();
      var foto_update_proses = $('#t4_foto').val();

      var dbRef_update_proses = firebase.database();
      var update_statusAlat = dbRef_update_proses.ref("project/" + id_update_proses);

      update_statusAlat.update ({
        "nama": nama_update_proses,
        "deskripsi": deskripsi_update_proses,
        "tipe": tipe_update_proses,
        "link": link_update_proses,
        "foto": foto_update_proses
      });

      $('#ModalUpdate').modal('hide');
      tampilData();
    }

    // Mengambil id terakhir dan membahkan dengan 1 dan memasukkan kedalam text id di modal tambah
    function ambilDataTerakhir() {

      $('#t4_nama_add').val("");
      $('#t4_deskripsi_add').val("");
      $('#t4_tipe_add').val("");
      $('#t4_link_add').val("");
      $('#t4_foto_add').val("");

      var dbRef_ambilDataTerakhir = firebase.database();
      var cariAkhir = dbRef_ambilDataTerakhir.ref("project");
      cariAkhir.limitToLast(1).on('child_added', function(dataAkhir) {
        var snap = dataAkhir.val();
        var id_record_terakhir = snap.id + 1;
        document.getElementById("T4_add").value = id_record_terakhir;
      });

    }

    // Melakukan proses penambahan data
    function addData_Proses() {
      var id_add_proses = $('#T4_add').val();
      var nama_add_proses = $('#t4_nama_add').val();
      var deskripsi_add_proses = $('#t4_deskripsi_add').val();
      var tipe_add_proses = $('#t4_tipe_add').val();
      var link_add_proses = $('#t4_link_add').val();
      var foto_add_proses = $('#t4_foto_add').val();

      var dbRef_add_proses = firebase.database();

      // Isikan data kedalam firebase
      var statusAlat = dbRef_add_proses.ref("project/" + id_add_proses);

      statusAlat.set({

        id: parseInt(id_add_proses),
        nama: nama_add_proses,
        deskripsi: deskripsi_add_proses,
        tipe: tipe_add_proses,
        link: link_add_proses,
        foto: foto_add_proses
      });

      $('#ModalAdd').modal('hide');
      tampilData();
    }

    // Melakukan proses delete data yang telah dikonfirmasi sebelumnya
    function delData_Proses() {
      var id_add_proses = $('#T4_del').val();

      var dbRef_delete = firebase.database();
      var statusAlat = dbRef_delete.ref("project/" + id_add_proses);
      statusAlat.remove();
      $('#ModalDel').modal('hide');
      tampilData();


    }

    // Memasukkan id ke textbox di modal konfirmasi delete
    function deleteData_Tampil(id) {
      $('#T4_del').val(id);
    }


  </script>

  <!-- Modal Update -->
  <div class="modal fade" id="ModalUpdate" tabindex="-1" role="dialog" aria-labelledby="ModalUpdateLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ModalUpdateLabel">Update Data</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <h6>Id : </h6>
          <input class="form-control" type="text" id="T4">
          <h6>Nama Project : </h6>
          <input class="form-control" type="text" id="t4_nama">
          <h6>Deskripsi Project : </h6>
          <input class="form-control" type="text" id="t4_deskripsi">
          <h6>Tipe : </h6>
          <select name="t4_tipe" id="t4_tipe" class="form-control">
            <option value="app">App</option>
            <option value="art">Art</option>
          </select>
          <h6>Link Project : </h6>
          <input class="form-control" type="text" id="t4_link">
          <h6>Foto Project : </h6>
          <input class="form-control" type="text" id="t4_foto">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-primary" onclick="updateData_Proses()">Simpan</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Add -->
  <div class="modal fade" id="ModalAdd" tabindex="-1" role="dialog" aria-labelledby="ModalAddLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ModalUpdateLabel">Tambah Data</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <h6>Id : </h6>
          <input class="form-control" type="text" id="T4_add">
          <h6>Nama Project : </h6>
          <input class="form-control" type="text" id="t4_nama_add">
          <h6>Deskripsi Project : </h6>
          <input class="form-control" type="text" id="t4_deskripsi_add">
          <h6>Tipe Project: </h6>
          <select name="t4_tipe" id="t4_tipe_add" class="form-control">
            <option value="app" selected>App</option>
            <option value="art">Art</option>
          </select>
          <h6>Link Project : </h6>
          <input class="form-control" type="text" id="t4_link_add">
          <h6>Foto Project : </h6>
          <input class="form-control" type="text" id="t4_foto_add">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-primary" onclick="addData_Proses()">Simpan</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Hapus Data -->
  <div class="modal fade" id="ModalDel" tabindex="-1" role="dialog" aria-labelledby="ModalDelLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ModalUpdateLabel">Konfirmasi Hapus Data</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <h6>ID : </h6>
          <input class="form-control" type="text" id="T4_del">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-danger" onclick="delData_Proses()">Hapus Data</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>